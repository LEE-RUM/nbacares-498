{% extends 'ProjectSite/calendar-base.html' %}
{% load static %}
{% load user_tags %}
{% load crispy_forms_filters %}

{% block title %}Calendar{% endblock title %}

{% block extracss %}
    <link href="{% static 'calendar/main.css' %}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" integrity="sha512-Oy+sz5W86PK0ZIkawrG0iv7XwWhYecM3exvUtMKNJMekGFJtVAhibhRPTpmyTj8+lJCkmWfnpxKgT2OopquBHA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock extracss %}


{% block content %}
    <main class="app-content">
        <div class="row">
            <div class="col-md-12">
                <div class="tile row">
                    <div class="col-md-3">
                        {% if user.is_authenticated and not user.is_superuser %}
                            <button id="addEvent" type="button" class="btn btn-primary" style="background-color: #834655">ADD EVENT</button>
                        {% endif %}
                        <div id="external-events">
                            <h4 class="mb-4">Filter Event</h4>
                            <form method="get">
                                {{ calendarFilter.form|crispy }}
                                <button class="btn btn-primary" type="submit">Search</button>
                            </form>
                            <a class="btn btn-dark btn-outline-light btn-lg btn-block my-2" href="{% url 'home' %}">&#8592; Back to Home</a>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div id="calendar"></div>
                    </div>
                    {% if user.is_authenticated and not user.is_superuser %}
                        <div class="modal fade show" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header bg-primary">
                                        <h5 class="modal-title text-white" id="exampleModalLongTitle">Add New Event</h5>
                                        <button id="modalClose1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <form method="post" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <div class="modal-body" style="height: 65vh;overflow-y: auto;">
                                            <div class="form-group">
                                                <label for="recipient-name" class="col-form-label">Event Title:</label>
                                                {{ form.event_name }}
                                            </div>
                                            <div class="form-group">
                                                <label for="message-text" class="col-form-label">Description:</label>
                                                {{ form.event_description }}
                                            </div>
                                            <div class="form-group">
                                                <label for="message-text" class="col-form-label">Start Date:</label>
                                                {{ form.event_sTime }}
                                            </div>
                                            <div class="form-group">
                                                <label for="message-text" class="col-form-label">End Date:</label>
                                                {{ form.event_eTime }}
                                            </div>
                                            <div class="form-group">
                                                {{ form.event_tag|as_crispy_field }}
                                            </div>
                                            <div class="form-group">
                                                {{ form.event_popper | as_crispy_field }}
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button id="modalClose2" type="button" class="btn btn-danger">Close</button>
                                            <button type="submit" class="btn btn-primary">Save</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="modal" id="modal-popper" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content text-center">
                    <div class="modal-header">
                        <h5 id="event-title" class="modal-title text-center"></h5>
                        <button id="popper-x" type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div id="image-url" class="modal-body"></div>                    
                    <form id="registerBtnForm" class="m-3"></form> 
                    <div class="modal-footer">
                        <div id="add-to-calendar" class="btn btn-primary"></div>
                        <button id="closePopper" type="button" class="btn btn-danger">Close</button>
                    </div>
                </div>
            </div>
        </div>


    </main>
{% endblock content %}

{% block extrascripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="{% static 'calendar/main.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var today = new Date();

            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
                },
                initialDate: today,
                navLinks: true, // can click day/week names to navigate views
                selectable: true,
                selectMirror: true,
                select: function(arg) {
                    var modal = document.getElementById('eventModal')
                    if (modal) {
                        modal.style.display = 'block'
                        calendar.unselect()
                    }
                },
                // THIS KEY WON'T WORK IN PRODUCTION!!!
                // To make your own Google API key, follow the directions here:
                // http://fullcalendar.io/docs/google_calendar/
                // googleCalendarApiKey: 'AIzaSyCqCxjjLtjbtkX37aOtWB8OfwBLy_6QuYk',

                // bangladesh Holidays
                // events: 'bn.bd#holiday@group.v.calendar.google.com',
                eventClick: function(arg) {
                    console.log(arg)

                    $.ajax({
                        type: "POST",
                        url: '{% url "calendar_event" %}',
                        data: {
                            event_id: arg.event._def.extendedProps.eventID,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        dataType: 'json',
                        success: function (data, status) {
                            $('#event-title').html(data.event_name)
                            $('#image-url').html(`<img src=${data.eventURL}> `)
                            renderAddToCalendar(arg, data)
                            renderRegisterBtn(data)
                            $('#modal-popper').css("display", "block")
                        },
                        error: function (res) {
                            alert(res.status);                                                                                                                          
                        },
                    });
                    
                    //if (confirm('Are you sure you want to delete this event?')) {
                    //arg.event.remove()
                    //}
                },
                editable: true,
                dayMaxEvents: true, // allow "more" link when too many events
                events: {{ event_list|safe }},
                // events: [
                //   {
                //     title: 'All Day Event',
                //     start: '2021-06-26'
                //   },
                //   {
                //     groupId: 999,
                //     title: 'Repeating Event',
                //     start: '2020-09-16T16:00:00'
                //   },
                //   {
                //     title: 'Conference',
                //     start: '2020-09-11',
                //     end: '2020-09-13'
                //   },
                //   {
                //     title: 'Click for Google',
                //     url: 'http://google.com/',
                //     start: '2020-09-28'
                //   }
                // ]
            });
            calendar.render();
            
        });
        
        const closeBtn1 = document.getElementById('modalClose1');
        const closeBtn2 = document.getElementById('modalClose2');
        const closeBtn3 = document.getElementById('closePopper');
        const closeBtn4 = document.getElementById('popper-x');
        const addBtn = document.getElementById('addEvent');
        if (closeBtn1) {
            closeBtn1.addEventListener('click',()=>{
                const eventModal = document.getElementById('eventModal')
                eventModal.style.display = 'none';
            });
        }
        if (closeBtn2) {
            closeBtn2.addEventListener('click',()=>{
                const eventModal = document.getElementById('eventModal')
                eventModal.style.display = 'none';
            });
        }
        closeBtn3.addEventListener('click',()=>{
            const modal_popper = document.getElementById('modal-popper')
            modal_popper.style.display = 'none';
        });
        closeBtn4.addEventListener('click',()=>{
            const modal_popper = document.getElementById('modal-popper')
            modal_popper.style.display = 'none';
        });
        if (addBtn) {
            addBtn.addEventListener('click',()=>{
                const modal = document.getElementById('eventModal')
                modal.style.display = 'block'
            });
        }

        const renderAddToCalendar = (arg, data) => {
            let startDate =  new Date(arg.event._instance.range.start.getTime() + arg.event._instance.range.start.getTimezoneOffset() * 60 *1000).toISOString().replace(/-|:|\.\d\d\d/g,"")
            let endDate =  new Date(arg.event._instance.range.end.getTime() + arg.event._instance.range.start.getTimezoneOffset() * 60 *1000).toISOString().replace(/-|:|\.\d\d\d/g,"")
            let hrefEvent = `https://calendar.google.com/calendar/r/eventedit?text=${encodeURIComponent(data.event_name)}&dates=${startDate}/${endDate}&ctz=UTC&details=${encodeURIComponent(data.eventDescription)}`
            html = `<a class="text-decoration-none text-white" href=${hrefEvent} target="_blank"><i class="bi bi-calendar2-plus"></i> Add To Google Calendar</a>`
            $('#add-to-calendar').html(html)
        }

        const renderRegisterBtn = (data) => {
            let likeBtn = (data.registered == true) ? `<button type="submit" class="btn btn-secondary"><i class="bi bi-bookmark-star-fill"></i> Registered</button>` : `<button type="submit" class="btn btn-success"><i class="bi bi-bookmark-star"></i> Register</button>`
            let html = `
                <input type='hidden' id="event_id" name='event_id' value="${data.eventID}">
                ${likeBtn}
                <strong>${data.registeredCount} people registered</strong>
            `
            $('#registerBtnForm').html(html)
        }

        $("#registerBtnForm").on('submit', (e) => {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: '{% url "register_event" %}',
                data: {
                    event_id: $('#event_id').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data, status) {
                    renderRegisterBtn(data)
                },
                error: function (res) {
                    alert(res.status);                                                                                                                          
                },
            });
        });

    </script>
{% endblock extrascripts %}